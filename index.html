<!DOCTYPE html>
<html>

<head>
  <title>g4o2</title>
</head>

<body>
  <div id="messages">
  </div>
  <form id='form' action="" autocomplete="off">
    <div>
      <input id='input' autocomplete="off" type="text" name="message" size="60" style="width: 55vw;"
        placeholder="Enter message and submit" /><button id="send">Send</button>
    </div>
  </form>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    var socket = io();

    var messages = document.getElementById('messages');
    var form = document.getElementById('form');
    var input = document.getElementById('input');
    var submitBtn = document.getElementById('send');
    do {
      username = prompt('Username');
    } while (username.match(/[^a-zA-Z0-9_]+/g))
    if (username) {
    	socket.emit('user-connect', username);
      socket.emit('load-messages', username);
    }
    socket.on('load-messages', function (data) {
        alert(data);
    })
		
		socket.on('user-connect', function (username) {
			var item = document.createElement('div');
			item.textContent = `User ${username} connected`;
			messages.appendChild(item);
			window.scrollTo(0, document.body.scrollHeight);
		})

		function escapeRegExp(string) {
			return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); // $& means the whole matched string
		}
		
		function replaceAll(str, find, replace) {
			return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);
		}
		socket.on('message-submit', function (messageDetails) {
			let pfpLink = '#';
			let item = document.createElement('div');
			let username = messageDetails.username;
			let date = messageDetails.date;
			date.toLocaleString();
			let message = messageDetails.message;
			let messageFiltered = message.replace(/[\u00A0-\u9999<>\&]/g, function (i) {
				return '&#' + i.charCodeAt(0) + ';';
			});
			item.innerHTML = `<div class='message-container'><p class='message-info'>${username} ${date}</p><p class='message'><span style='word-wrap: break-word;'>${messageFiltered}</span></p></div>`;
			messages.appendChild(item);
			let chat = document.getElementById('messages')
			chat.scrollTop = chat.scrollHeight;
			submitBtn.classList.add('not-allowed');
			setTimeout(() => {
				submitBtn.classList.remove('not-allowed');
			}, "3000")
		});
		
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      if (input.value) {
        let date = new Date().toLocaleString();
        messageDetails = {
          username: replaceAll(username, '<', ''),
          message: replaceAll(input.value, '<', ''),
          date: date
        }
        socket.emit('message-submit', messageDetails);
        input.value = '';
      }
    });

    window.addEventListener("keydown", event => {
      if ((event.keyCode == 191)) {
        if (input === document.activeElement) {
          return;
        } else {
          input.focus();
          input.select();
          event.preventDefault();
        }
      }
      if ((event.keyCode == 27)) {
        if (input === document.activeElement) {
          document.activeElement.blur();
          window.focus();
          event.preventDefault();
        }
      }
    });
  </script>
</body>

</html>